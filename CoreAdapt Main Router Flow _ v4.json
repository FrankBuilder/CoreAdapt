{
  "name": "CoreAdapt Main Router Flow | v4",
  "nodes": [
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "lO3F2ESDmnRVMaBz",
          "mode": "list",
          "cachedResultUrl": "/workflow/lO3F2ESDmnRVMaBz",
          "cachedResultName": "Normalize Evolution API | v4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "raw_webhook_data": "={{ $json }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -3520,
        -288
      ],
      "id": "995015e7-8a9d-466c-a68a-d4b82084be5e",
      "name": "Execute: Normalize Evolution Data"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "audio-check",
              "leftValue": "={{ $json.media_type }}",
              "rightValue": "audio",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1952,
        -96
      ],
      "id": "ffabd147-76c0-4d37-aba0-0373f6d659f2",
      "name": "Route: Audio Messages"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -1504,
        -96
      ],
      "id": "d66cfab6-578f-430d-bdb5-5bdb08351646",
      "name": "Merge: Audio and Text",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "not-broadcast",
              "leftValue": "={{ $('Execute: Normalize Evolution Data').item.json.whatsapp_id }}",
              "rightValue": "status@broadcast",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            },
            {
              "id": "not-from-me",
              "leftValue": "={{ $('Execute: Normalize Evolution Data').item.json.is_from_me }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "7c08cbd9-be25-4002-a6cf-68042a53ee56",
      "name": "Filter: Valid Messages",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1280,
        -96
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  message_id,\n  whatsapp_id,\n  received_at\nFROM corev4_message_dedup\nWHERE whatsapp_id = '={{ $json.whatsapp_id }}'\n  AND received_at > NOW() - INTERVAL '5 seconds'\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1056,
        -96
      ],
      "id": "561bb633-6ad3-4e13-a76f-4c6ac9513fc6",
      "name": "Query: Message Deduplication",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "HCvX4Ypw2MiRDsdm",
          "name": "Postgres Core"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "duplicate-exists",
              "leftValue": "={{ $input.all().length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -832,
        -96
      ],
      "id": "f136713c-4fce-4ca7-b6f2-104f95d1582c",
      "name": "Route: Duplicate Detection"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"status\": \"received\", \n  \"messageId\": $json.message_id\n} }}",
        "options": {}
      },
      "id": "4e666007-3895-43ce-87ad-7bbddb8fe82c",
      "name": "Respond: Webhook Acknowledgment",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -384,
        -96
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "norm-phone",
              "name": "normalized_phone",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.phone_number }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "d76dae5a-148f-46b8-a334-774e4ea39b31",
      "name": "Prepare: Contact Lookup",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -160,
        -96
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "corev4_contacts",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "whatsapp",
              "condition": "eq",
              "keyValue": "={{ $('Execute: Normalize Evolution Data').item.json.whatsapp_id }}"
            }
          ]
        }
      },
      "id": "5b2c2dfb-9760-479d-9ce2-f3529fb64f7d",
      "name": "Fetch: Contact Record",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        64,
        -96
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "LCC4ysI1Fxd9iDGz",
          "name": "Supabase Core"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "enrich-1",
              "name": "contact_id",
              "value": "={{ $('Fetch: Contact Record').first().json.id || null }}",
              "type": "number"
            },
            {
              "id": "enrich-2",
              "name": "company_id",
              "value": "={{ $json.company_id || 1 }}",
              "type": "number"
            },
            {
              "id": "enrich-3",
              "name": "opt_out",
              "value": "={{ $('Fetch: Contact Record').first().json.opt_out === true }}",
              "type": "boolean"
            },
            {
              "id": "enrich-4",
              "name": "contact_exists",
              "value": "={{ $('Fetch: Contact Record').first().json.id != null && $('Fetch: Contact Record').first().json.id !== undefined }}",
              "type": "boolean"
            },
            {
              "id": "enrich-5",
              "name": "whatsapp_id",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.whatsapp_id }}",
              "type": "string"
            },
            {
              "id": "enrich-6",
              "name": "contact_name",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.contact_name }}",
              "type": "string"
            },
            {
              "id": "enrich-7",
              "name": "message_content",
              "value": "={{ $('Merge: Audio and Text').item.json.message_content ?? $('Execute: Normalize Evolution Data').item.json.message_content }}",
              "type": "string"
            },
            {
              "id": "enrich-8",
              "name": "message_type",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.message_type }}",
              "type": "string"
            },
            {
              "id": "enrich-9",
              "name": "phone_number",
              "value": "={{ $('Prepare: Contact Lookup').item.json.normalized_phone }}",
              "type": "string"
            },
            {
              "id": "enrich-11",
              "name": "evolution_api_url",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.evolution_api_url }}",
              "type": "string"
            },
            {
              "id": "enrich-12",
              "name": "evolution_instance",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.evolution_instance }}",
              "type": "string"
            },
            {
              "id": "api-key",
              "name": "evolution_api_key",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.api_key}}",
              "type": "string"
            },
            {
              "id": "2c236264-2678-4d1b-8fc9-ec158ce0cf17",
              "name": "message_id",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.message_id }}",
              "type": "string"
            },
            {
              "id": "4da4aae5-b0d1-4897-a5d7-65a3b586f106",
              "name": "quoted_message",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.quoted_message }}",
              "type": "string"
            },
            {
              "id": "0cd3f0b7-804a-4c6f-ac32-3d92b4abe7bb",
              "name": "transcribed",
              "value": "={{ $('Merge: Audio and Text').item.json.transcribed }}",
              "type": "string"
            },
            {
              "id": "a840a24b-a174-4b17-ba7c-575ad2339596",
              "name": "sender_type",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.sender_type }}",
              "type": "string"
            },
            {
              "id": "e4835d75-4bdf-488e-bb10-90cfe3a29bb3",
              "name": "has_media",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.has_media }}",
              "type": "boolean"
            },
            {
              "id": "f15fcd0e-b641-4920-a2b2-e211ca0bdaf1",
              "name": "media_url",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.media_url }}",
              "type": "string"
            },
            {
              "id": "d674b258-0ce2-4592-9369-83d651a44bca",
              "name": "media_mime_type",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.media_mime_type }}",
              "type": "string"
            },
            {
              "id": "ad2c63bf-6879-4d96-8f33-ea2bb74221ff",
              "name": "media_type",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.media_type }}",
              "type": "string"
            },
            {
              "id": "bc0b4f5b-eb47-412f-acef-dd4cd737a48d",
              "name": "caption",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.caption }}",
              "type": "string"
            },
            {
              "id": "0c8ceb5f-9f7d-4eb6-b336-d24c9d360a41",
              "name": "body.data.message.base64",
              "value": "={{ $('Execute: Normalize Evolution Data').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "fc008aee-286d-47c1-9e74-321b06dcd968",
      "name": "Enrich: Message Context",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        288,
        -96
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "is-new",
                    "leftValue": "={{ $json.contact_exists }}",
                    "rightValue": false,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "new_contact"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "is-blocked",
                    "leftValue": "={{ $json.contact_exists }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "is-optout",
                    "leftValue": "={{ $json.opt_out }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "blocked_contact"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "is-active",
                    "leftValue": "={{ $json.contact_exists }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "not-blocked",
                    "leftValue": "={{ $json.opt_out }}",
                    "rightValue": false,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "is-command",
                    "leftValue": "={{ $json.message_content }}",
                    "rightValue": "#",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "command"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "is-active-chat",
                    "leftValue": "={{ $json.contact_exists }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "not-blocked-chat",
                    "leftValue": "={{ $json.opt_out }}",
                    "rightValue": false,
                    "operator": {
                      "type": "boolean",
                      "operation": "equals"
                    }
                  },
                  {
                    "id": "not-command",
                    "leftValue": "={{ $json.message_content }}",
                    "rightValue": "#",
                    "operator": {
                      "type": "string",
                      "operation": "notStartsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "active_chat"
            }
          ]
        },
        "options": {}
      },
      "id": "f33fbdb5-b889-4f83-9503-63230e51d190",
      "name": "Route: Contact Status",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        512,
        -240
      ]
    },
    {
      "parameters": {
        "numberInputs": 4
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1184,
        -416
      ],
      "id": "7fd332d2-3903-4937-9a0b-214c9cee59e0",
      "name": "Merge: Workflow Results"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "93a82cff-d762-4f9a-ac79-713f2f3c1580",
              "name": "contact_id",
              "value": "={{ $('Prepare: Frank Chat').item.json.contact_id }}",
              "type": "number"
            },
            {
              "id": "0d30cb13-f159-419b-af3a-bfeb6ddaf11b",
              "name": "company_id",
              "value": "={{ $('Prepare: Frank Chat').item.json.company_id }}",
              "type": "number"
            },
            {
              "id": "7d2a251f-73ac-4791-92d4-52aa9f33b5fa",
              "name": "opt_out",
              "value": "={{ $('Prepare: Frank Chat').item.json.opt_out }}",
              "type": "boolean"
            },
            {
              "id": "3b6e9ae7-9b99-4aff-8cd3-4d42c620729e",
              "name": "contact_exists",
              "value": "={{ $('Prepare: Frank Chat').item.json.contact_exists }}",
              "type": "boolean"
            },
            {
              "id": "55701e38-6b5c-41fc-b635-efdeb6e6b723",
              "name": "whatsapp_id",
              "value": "={{ $('Prepare: Frank Chat').item.json.whatsapp_id }}",
              "type": "string"
            },
            {
              "id": "964095a2-df99-4e19-9b3e-33862db81fed",
              "name": "contact_name",
              "value": "={{ $('Prepare: Frank Chat').item.json.contact_name }}",
              "type": "string"
            },
            {
              "id": "3e320c10-c9ee-4df4-b52f-57912fc476a1",
              "name": "message_content",
              "value": "={{ $('Prepare: Frank Chat').item.json.message_content }}",
              "type": "string"
            },
            {
              "id": "853ab5e9-2593-4779-802f-607808d3512e",
              "name": "message_type",
              "value": "={{ $('Prepare: Frank Chat').item.json.message_type }}",
              "type": "string"
            },
            {
              "id": "753a83ac-230c-4bb9-abd7-e64da5356f2a",
              "name": "phone_number",
              "value": "={{ $('Prepare: Frank Chat').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "52e9bd50-5fc7-455e-ac13-e3e9108da93d",
              "name": "evolution_api_url",
              "value": "={{ $('Prepare: Frank Chat').item.json.evolution_api_url }}",
              "type": "string"
            },
            {
              "id": "30c9a5e6-7976-43c9-b5a5-808b05d7f673",
              "name": "evolution_instance",
              "value": "={{ $('Prepare: Frank Chat').item.json.evolution_instance }}",
              "type": "string"
            },
            {
              "id": "42a9486b-741c-4bb7-9e1d-ed4ef7e27bbb",
              "name": "evolution_api_key",
              "value": "={{ $('Prepare: Frank Chat').item.json.evolution_api_key }}",
              "type": "string"
            },
            {
              "id": "8829cb40-f58a-4476-bf0b-10025d80fcc0",
              "name": "message_id",
              "value": "={{ $('Prepare: Frank Chat').item.json.message_id }}",
              "type": "string"
            },
            {
              "id": "33701714-d7ac-4e2b-aaf6-65cfc0b5bf98",
              "name": "quoted_message",
              "value": "={{ $('Prepare: Frank Chat').item.json.quoted_message }}",
              "type": "string"
            },
            {
              "id": "213ca5b0-3b1a-4350-a1c3-097127b31c21",
              "name": "transcribed",
              "value": "={{ $('Prepare: Frank Chat').item.json.transcribed }}",
              "type": "string"
            },
            {
              "id": "277fa303-3d9a-436a-a258-deae5c71642e",
              "name": "has_media",
              "value": "={{ $('Prepare: Frank Chat').item.json.has_media }}",
              "type": "boolean"
            },
            {
              "id": "fd60bb78-2f91-4fd7-b7eb-8dc3d9b93301",
              "name": "media_url",
              "value": "={{ $('Prepare: Frank Chat').item.json.media_url }}",
              "type": "string"
            },
            {
              "id": "a0e1f58f-5dd8-4f34-a38d-0721313e60f0",
              "name": "media_mime_type",
              "value": "={{ $('Prepare: Frank Chat').item.json.media_mime_type }}",
              "type": "string"
            },
            {
              "id": "c626e966-4d30-498b-b924-7b6e48c61e6b",
              "name": "media_type",
              "value": "={{ $('Prepare: Frank Chat').item.json.media_type }}",
              "type": "string"
            },
            {
              "id": "bc0a9d25-2514-43ed-a7b3-3a3ff8c89fcf",
              "name": "caption",
              "value": "={{ $('Prepare: Frank Chat').item.json.caption }}",
              "type": "string"
            },
            {
              "id": "b1ad8d28-0d72-486a-8036-8c8a83b751de",
              "name": "sender_type",
              "value": "={{ $('Prepare: Frank Chat').item.json.sender_type }}",
              "type": "string"
            },
            {
              "id": "281d672e-1fca-4950-ba79-59709eb483d9",
              "name": "body.data.message.base64",
              "value": "={{ $('Prepare: Frank Chat').item.json['body.data.message.base64'] }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1632,
        -288
      ],
      "id": "3a0263b7-4225-444d-affc-46cf40374b9c",
      "name": "Restore: Frank Context"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "v6ujbeRaSjlJb6Jd",
          "mode": "list",
          "cachedResultUrl": "/workflow/v6ujbeRaSjlJb6Jd",
          "cachedResultName": "Process Audio Message | v4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "whatsapp_id": "={{ $json.whatsapp_id }}",
            "evolution_instance": "={{ $json.evolution_instance }}",
            "message_type": "={{ $json.message_type }}",
            "is_from_me": "={{ $json.is_from_me }}",
            "message_timestamp": "={{ $json.message_timestamp }}",
            "contact_name": "={{ $json.contact_name }}",
            "message_content": "={{ $json.message_content }}",
            "has_media": "={{ $json.has_media }}",
            "media_type": "={{ $json.media_type }}",
            "media_url": "={{ $json.media_url }}",
            "media_mime_type": "={{ $json.media_mime_type }}",
            "is_broadcast": "={{ $json.is_broadcast }}",
            "participant": "={{ $json.participant }}",
            "quoted_message": "={{ $json.quoted_message }}",
            "evolution_api_url": "={{ $json.evolution_api_url }}",
            "api_key": "={{ $json.api_key }}",
            "message_id": "={{ $json.message_id }}",
            "phone_number": "={{ $json.phone_number }}",
            "is_text_message": "={{ $json.is_text_message }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -1728,
        -160
      ],
      "id": "669a6b9f-a106-4869-9262-4794a3610e44",
      "name": "Execute: Transcribe Audio"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO corev4_message_dedup (\n  message_id,\n  whatsapp_id,\n  received_at,\n  processed\n) VALUES (\n  '={{ $('Execute: Normalize Evolution Data').item.json.message_id }}',\n  '={{ $('Execute: Normalize Evolution Data').item.json.whatsapp_id }}',\n  NOW(),\n  false\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -608,
        -16
      ],
      "id": "a9989a8c-4b58-4e73-aade-05161016849a",
      "name": "Insert: Deduplication Record",
      "credentials": {
        "postgres": {
          "id": "HCvX4Ypw2MiRDsdm",
          "name": "Postgres Core"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "core-adapt-v4",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -3744,
        -288
      ],
      "id": "8da63cdc-325f-40c7-837a-ee29f2db2371",
      "name": "Receive: WhatsApp Webhook",
      "webhookId": "8b811073-1a50-4741-90a1-16fbea33afc3"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prep-1",
              "name": "contact_id",
              "value": "={{ $('Enrich: Message Context').item.json.contact_id }}",
              "type": "string"
            },
            {
              "id": "prep-2",
              "name": "company_id",
              "value": "={{ $('Enrich: Message Context').item.json.company_id }}",
              "type": "string"
            },
            {
              "id": "prep-3",
              "name": "opt_out",
              "value": "={{ $('Enrich: Message Context').item.json.opt_out }}",
              "type": "string"
            },
            {
              "id": "prep-4",
              "name": "contact_exists",
              "value": "={{ $('Enrich: Message Context').item.json.contact_exists }}",
              "type": "string"
            },
            {
              "id": "prep-5",
              "name": "whatsapp_id",
              "value": "={{ $('Enrich: Message Context').item.json.whatsapp_id }}",
              "type": "string"
            },
            {
              "id": "prep-6",
              "name": "contact_name",
              "value": "={{ $('Enrich: Message Context').item.json.contact_name }}",
              "type": "string"
            },
            {
              "id": "prep-7",
              "name": "message_content",
              "value": "={{ $('Enrich: Message Context').item.json.message_content }}",
              "type": "string"
            },
            {
              "id": "prep-8",
              "name": "message_type",
              "value": "={{ $('Enrich: Message Context').item.json.message_type }}",
              "type": "string"
            },
            {
              "id": "prep-9",
              "name": "phone_number",
              "value": "={{ $('Enrich: Message Context').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "prep-10",
              "name": "evolution_api_url",
              "value": "={{ $('Enrich: Message Context').item.json.evolution_api_url }}",
              "type": "string"
            },
            {
              "id": "prep-11",
              "name": "evolution_instance",
              "value": "={{ $('Enrich: Message Context').item.json.evolution_instance }}",
              "type": "string"
            },
            {
              "id": "prep-12",
              "name": "origin_source",
              "value": "={{ $('Enrich: Message Context').item.json.origin_source }}",
              "type": "string"
            },
            {
              "id": "prep-13",
              "name": "evolution_api_key",
              "value": "={{ $('Enrich: Message Context').item.json.evolution_api_key }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "e04661dd-3315-4960-9ea3-c4b08697d08d",
      "name": "Prepare: Create Contact",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        736,
        -480
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prep-react-1",
              "name": "contact_id",
              "value": "={{ $('Enrich: Message Context').item.json.contact_id }}",
              "type": "number"
            },
            {
              "id": "prep-react-2",
              "name": "company_id",
              "value": "={{ $('Enrich: Message Context').item.json.company_id }}",
              "type": "number"
            },
            {
              "id": "prep-react-3",
              "name": "opt_out",
              "value": "={{ $('Enrich: Message Context').item.json.opt_out }}",
              "type": "string"
            },
            {
              "id": "prep-react-4",
              "name": "contact_exists",
              "value": "={{ $('Enrich: Message Context').item.json.contact_exists }}",
              "type": "string"
            },
            {
              "id": "prep-react-5",
              "name": "whatsapp_id",
              "value": "={{ $('Enrich: Message Context').item.json.whatsapp_id }}",
              "type": "string"
            },
            {
              "id": "prep-react-6",
              "name": "contact_name",
              "value": "={{ $('Enrich: Message Context').item.json.contact_name }}",
              "type": "string"
            },
            {
              "id": "prep-react-7",
              "name": "message_content",
              "value": "={{ $('Enrich: Message Context').item.json.message_content }}",
              "type": "string"
            },
            {
              "id": "prep-react-8",
              "name": "message_type",
              "value": "={{ $('Enrich: Message Context').item.json.message_type }}",
              "type": "string"
            },
            {
              "id": "prep-react-9",
              "name": "phone_number",
              "value": "={{ $('Enrich: Message Context').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "prep-react-10",
              "name": "evolution_api_url",
              "value": "={{ $('Enrich: Message Context').item.json.evolution_api_url }}",
              "type": "string"
            },
            {
              "id": "prep-react-11",
              "name": "evolution_instance",
              "value": "={{ $('Enrich: Message Context').item.json.evolution_instance }}",
              "type": "string"
            },
            {
              "id": "prep-react-12",
              "name": "origin_source",
              "value": "={{ $('Enrich: Message Context').item.json.origin_source }}",
              "type": "string"
            },
            {
              "id": "prep-react-13",
              "name": "evolution_api_key",
              "value": "={{ $('Enrich: Message Context').item.json.evolution_api_key }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "1f450a86-aad4-4c4f-aec0-2dc06f9da36f",
      "name": "Prepare: Reactivate",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        736,
        -288
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prep-cmd-1",
              "name": "contact_id",
              "value": "={{ $('Enrich: Message Context').item.json.contact_id }}",
              "type": "number"
            },
            {
              "id": "prep-cmd-2",
              "name": "company_id",
              "value": "={{ $('Enrich: Message Context').item.json.company_id }}",
              "type": "number"
            },
            {
              "id": "prep-cmd-3",
              "name": "opt_out",
              "value": "={{ $('Enrich: Message Context').item.json.opt_out }}",
              "type": "string"
            },
            {
              "id": "prep-cmd-4",
              "name": "contact_exists",
              "value": "={{ $('Enrich: Message Context').item.json.contact_exists }}",
              "type": "string"
            },
            {
              "id": "prep-cmd-5",
              "name": "whatsapp_id",
              "value": "={{ $('Enrich: Message Context').item.json.whatsapp_id }}",
              "type": "string"
            },
            {
              "id": "prep-cmd-6",
              "name": "contact_name",
              "value": "={{ $('Enrich: Message Context').item.json.contact_name }}",
              "type": "string"
            },
            {
              "id": "prep-cmd-7",
              "name": "message_content",
              "value": "={{ $('Enrich: Message Context').item.json.message_content }}",
              "type": "string"
            },
            {
              "id": "prep-cmd-8",
              "name": "message_type",
              "value": "={{ $('Enrich: Message Context').item.json.message_type }}",
              "type": "string"
            },
            {
              "id": "prep-cmd-9",
              "name": "phone_number",
              "value": "={{ $('Enrich: Message Context').item.json.phone_number }}",
              "type": "string"
            },
            {
              "id": "prep-cmd-10",
              "name": "evolution_api_url",
              "value": "={{ $('Enrich: Message Context').item.json.evolution_api_url }}",
              "type": "string"
            },
            {
              "id": "prep-cmd-11",
              "name": "evolution_instance",
              "value": "={{ $('Enrich: Message Context').item.json.evolution_instance }}",
              "type": "string"
            },
            {
              "id": "prep-cmd-12",
              "name": "origin_source",
              "value": "={{ $('Enrich: Message Context').item.json.origin_source }}",
              "type": "string"
            },
            {
              "id": "prep-cmd-13",
              "name": "evolution_api_key",
              "value": "={{ $('Enrich: Message Context').item.json.evolution_api_key }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "4f871bbb-8cfd-49c9-8c2c-8c6a2914186b",
      "name": "Prepare: Process Command",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        736,
        16
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DF0p6UjtkmqCOv2Y",
          "mode": "list",
          "cachedResultUrl": "/workflow/DF0p6UjtkmqCOv2Y",
          "cachedResultName": "Reactivate Blocked Contact | v4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "contact_id": "={{ $json.contact_id }}",
            "company_id": "={{ $json.company_id }}",
            "opt_out": "={{ $json.opt_out }}",
            "contact_exists": "={{ $json.contact_exists }}",
            "whatsapp_id": "={{ $json.whatsapp_id }}",
            "contact_name": "={{ $json.contact_name }}",
            "message_content": "={{ $json.message_content }}",
            "message_type": "={{ $json.message_type }}",
            "phone_number": "={{ $json.phone_number }}",
            "evolution_api_url": "={{ $json.evolution_api_url }}",
            "evolution_instance": "={{ $json.evolution_instance }}",
            "origin_source": "={{ $json.origin_source }}",
            "evolution_api_key": "={{ $json.evolution_api_key }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        960,
        -288
      ],
      "id": "6170cbf2-723b-4df6-9eef-ed2158089bc0",
      "name": "Execute: Reactivate Contact"
    },
    {
      "parameters": {
        "jsCode": "// Pegar o item do merge\nconst item = $input.first().json;\n\n// Determinar a source correta dos dados\nlet contactId, companyId, whatsappId, contactName, messageContent, messageType;\nlet phoneNumber, evolutionApiUrl, evolutionInstance, evolutionApiKey, originSource, optOut, messageId, pushName;\n\n// Se veio do Execute: Create Contact (tem success: true e contact_id)\nif (item.success && item.contact_id) {\n  const context = $('Enrich: Message Context').first().json;\n  \n  contactId = item.contact_id;\n  companyId = context.company_id;\n  whatsappId = context.whatsapp_id;\n  contactName = context.contact_name;\n  messageContent = context.message_content;\n  messageType = context.message_type;\n  phoneNumber = context.phone_number;\n  evolutionApiUrl = context.evolution_api_url;\n  evolutionInstance = context.evolution_instance;\n  evolutionApiKey = context.evolution_api_key;\n  originSource = context.origin_source;\n  optOut = false;\n  messageId = context.messageId || context.message_id;  // âœ… CORRIGIDO\n  pushName = context.pushName || context.push_name;      // âœ… CORRIGIDO\n}\n// Se veio do Execute: Reactivate\nelse if (item.contactId && item.message) {\n  const context = $('Enrich: Message Context').first().json;\n  \n  contactId = item.contactId;\n  companyId = context.company_id;\n  whatsappId = context.whatsapp_id;\n  contactName = context.contactName || context.contact_name;\n  messageContent = context.message_content;\n  messageType = context.message_type;\n  phoneNumber = context.phone_number;\n  evolutionApiUrl = context.evolution_api_url;\n  evolutionInstance = context.evolution_instance;\n  evolutionApiKey = context.evolution_api_key;\n  originSource = context.origin_source;\n  optOut = false;\n  messageId = context.messageId || context.message_id;  // âœ… CORRIGIDO\n  pushName = context.pushName || context.push_name;      // âœ… CORRIGIDO\n}\n// Se veio do Execute: Process Commands\nelse if (item.command_executed) {\n  const context = $('Enrich: Message Context').first().json;\n  \n  contactId = item.contact_id;\n  companyId = context.company_id;\n  whatsappId = context.whatsapp_id;\n  contactName = context.contact_name;\n  messageContent = context.message_content;\n  messageType = context.message_type;\n  phoneNumber = context.phone_number;\n  evolutionApiUrl = context.evolution_api_url;\n  evolutionInstance = context.evolution_instance;\n  evolutionApiKey = context.evolution_api_key;\n  originSource = context.origin_source;\n  optOut = item.opt_out || false;\n  messageId = context.messageId || context.message_id;  // âœ… CORRIGIDO\n  pushName = context.pushName || context.push_name;      // âœ… CORRIGIDO\n}\n// Se veio direto (active_chat)\nelse {\n  contactId = item.contact_id;\n  companyId = item.company_id;\n  whatsappId = item.whatsapp_id;\n  contactName = item.contact_name;\n  messageContent = item.message_content;\n  messageType = item.message_type;\n  phoneNumber = item.phone_number;\n  evolutionApiUrl = item.evolution_api_url;\n  evolutionInstance = item.evolution_instance;\n  evolutionApiKey = item.evolution_api_key;\n  originSource = item.origin_source;\n  optOut = item.opt_out;\n  messageId = item.messageId || item.message_id;        // âœ… CORRIGIDO\n  pushName = item.pushName || item.push_name;            // âœ… CORRIGIDO\n}\n\n// Pegar TODOS os dados de Enrich: Message Context (incluindo base64, media, etc)\nconst enrichContext = $('Enrich: Message Context').first().json;\nconst normalizeData = $('Execute: Normalize Evolution Data').first().json;\n\n// Pegar base64 corretamente\nconst base64Data = normalizeData?.body?.data?.message?.base64 || enrichContext?.body?.data?.message?.base64 || null;\n\nreturn [{\n  json: {\n    contact_id: contactId,\n    company_id: companyId,\n    whatsapp_id: whatsappId,\n    message_id: messageId,                              // âœ… Agora sempre terÃ¡ valor\n    contact_name: contactName,\n    message_content: messageContent,\n    message_type: messageType,\n    phone_number: phoneNumber,\n    evolution_api_url: evolutionApiUrl,\n    evolution_instance: evolutionInstance,\n    evolution_api_key: evolutionApiKey,\n    origin_source: originSource,\n    opt_out: optOut,\n    contact_exists: enrichContext.contact_exists,\n    quoted_message: enrichContext.quoted_message,\n    transcribed: enrichContext.transcribed,\n    has_media: enrichContext.has_media,\n    media_url: enrichContext.media_url,\n    media_mime_type: enrichContext.media_mime_type,\n    media_type: enrichContext.media_type,\n    caption: enrichContext.caption,\n    sender_type: normalizeData.sender_type,\n    'body.data.message.base64': base64Data\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        -288
      ],
      "id": "4db825b9-d1a4-4343-ba2f-2fb67fa081b7",
      "name": "Prepare: Frank Chat"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "pvMsb1uQbB0E3LAF",
          "mode": "list",
          "cachedResultUrl": "/workflow/pvMsb1uQbB0E3LAF",
          "cachedResultName": "CoreAdapt One Flow | v4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "contact_id": "={{ $json.contact_id }}",
            "company_id": "={{ $json.company_id }}",
            "opt_out": "={{ $json.opt_out }}",
            "contact_exists": "={{ $json.contact_exists }}",
            "whatsapp_id": "={{ $json.whatsapp_id }}",
            "contact_name": "={{ $json.contact_name }}",
            "message_content": "={{ $json.message_content }}",
            "message_type": "={{ $json.message_type }}",
            "phone_number": "={{ $json.phone_number }}",
            "evolution_api_url": "={{ $json.evolution_api_url }}",
            "evolution_instance": "={{ $json.evolution_instance }}",
            "evolution_api_key": "={{ $json.evolution_api_key }}",
            "message_id": "={{ $json.message_id }}",
            "quoted_message": "={{ $json.quoted_message }}",
            "transcribed": "={{ $json.transcribed }}",
            "has_media": "={{ $json.has_media }}",
            "media_url": "={{ $json.media_url }}",
            "media_mime_type": "={{ $json.media_mime_type }}",
            "media_type": "={{ $json.media_type }}",
            "caption": "={{ $json.caption }}",
            "sender_type": "={{ $json.sender_type }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        1856,
        -288
      ],
      "id": "8d9449c0-ebd6-4426-affb-bcdd1054d6a1",
      "name": "Execute: CoreAdapt One Flow"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "FkBpLfoPH1oHhWGa",
          "mode": "list",
          "cachedResultUrl": "/workflow/FkBpLfoPH1oHhWGa",
          "cachedResultName": "CoreAdapt Genesis Flow | v4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "contact_id": "={{ $json.contact_id }}",
            "company_id": "={{ $json.company_id }}",
            "opt_out": "={{ $json.opt_out }}",
            "contact_exists": "={{ $json.contact_exists }}",
            "whatsapp_id": "={{ $json.whatsapp_id }}",
            "contact_name": "={{ $json.contact_name }}",
            "message_content": "={{ $json.message_content }}",
            "message_type": "={{ $json.message_type }}",
            "phone_number": "={{ $json.phone_number }}",
            "evolution_api_url": "={{ $json.evolution_api_url }}",
            "evolution_instance": "={{ $json.evolution_instance }}",
            "origin_source": "={{ $json.origin_source }}",
            "evolution_api_key": "={{ $json.evolution_api_key }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        960,
        -480
      ],
      "id": "7ccd37d5-7b29-47da-ad29-e2e0d5cac792",
      "name": "Execute: CoreAdapt Genesis Flow"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "JveEQlvxC8lIx2pU",
          "mode": "list",
          "cachedResultUrl": "/workflow/JveEQlvxC8lIx2pU",
          "cachedResultName": "CoreAdapt Commands Flow | v4"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "contact_id": "={{ $json.contact_id }}",
            "company_id": "={{ $json.company_id }}",
            "opt_out": "={{ $json.opt_out }}",
            "contact_exists": "={{ $json.contact_exists }}",
            "whatsapp_id": "={{ $json.whatsapp_id }}",
            "contact_name": "={{ $json.contact_name }}",
            "message_content": "={{ $json.message_content }}",
            "message_type": "={{ $json.message_type }}",
            "phone_number": "={{ $json.phone_number }}",
            "evolution_api_url": "={{ $json.evolution_api_url }}",
            "evolution_instance": "={{ $json.evolution_instance }}",
            "origin_source": "={{ $json.origin_source }}",
            "evolution_api_key": "={{ $json.evolution_api_key }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        960,
        16
      ],
      "id": "03c1b120-7846-49ac-a8a9-989a6ee9ab17",
      "name": "Execute: CoreAdapt Commands Flow"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- 1. UPSERT: Criar ou atualizar last_interaction_at em contact_extras\nINSERT INTO corev4_contact_extras (contact_id, last_interaction_at)\nVALUES ({{ $json.contact_id }}, NOW())\nON CONFLICT (contact_id) DO UPDATE\nSET last_interaction_at = NOW();\n\n-- 2. Reagendar steps pendentes baseado no tempo de silêncio configurado\nUPDATE corev4_followup_executions e\nSET scheduled_at = NOW() + (fs.wait_hours || ' hours')::interval + (COALESCE(fs.wait_minutes, 0) || ' minutes')::interval\nFROM corev4_followup_steps fs\nJOIN corev4_followup_campaigns fc ON fc.id = e.campaign_id\nWHERE e.contact_id = {{ $json.contact_id }}\n  AND e.executed = false\n  AND fs.config_id = fc.config_id\n  AND fs.step_number = e.step;",
        "options": {}
      },
      "id": "9e4140d2-69c4-476b-80eb-9f5d25f781bb",
      "name": "Background: Update Interaction & Reschedule",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        512,
        32
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "HCvX4Ypw2MiRDsdm",
          "name": "Postgres Core"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  c.id as chat_id,\n  c.contact_id,\n  c.batch_expires_at,\n  c.batch_messages,\n  EXTRACT(EPOCH FROM (c.batch_expires_at - NOW())) AS seconds_remaining\nFROM corev4_chats c\nINNER JOIN corev4_contacts ct ON c.contact_id = ct.id\nWHERE ct.whatsapp = '={{ $json.whatsapp_id }}'\n  AND c.company_id = {{ $json.company_id || 1 }}\n  AND c.batch_collecting = TRUE\n  AND c.batch_expires_at > NOW()\nLIMIT 1;",
        "options": {}
      },
      "id": "08f56046-0f42-4bea-9e2f-7077e4f71531",
      "name": "Batch: Check Active",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3296,
        -288
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "HCvX4Ypw2MiRDsdm",
          "name": "Postgres Core"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "batch-found",
              "leftValue": "={{ $('Batch: Check Active').item.json.chat_id != null }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "a9bc6310-33aa-4cbb-a000-090f70794ef8",
      "name": "Batch: Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3072,
        -288
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE corev4_chats\nSET\n  batch_messages = batch_messages || ARRAY[\n    jsonb_build_object(\n      'message_id', '={{ $('Execute: Normalize Evolution Data').item.json.message_id }}',\n      'whatsapp_id', '={{ $('Execute: Normalize Evolution Data').item.json.whatsapp_id }}',\n      'message_content', '={{ $('Execute: Normalize Evolution Data').item.json.message_content }}',\n      'message_type', '={{ $('Execute: Normalize Evolution Data').item.json.message_type }}',\n      'media_type', '={{ $('Execute: Normalize Evolution Data').item.json.media_type }}',\n      'has_media', {{ $('Execute: Normalize Evolution Data').item.json.has_media }},\n      'media_url', '={{ $('Execute: Normalize Evolution Data').item.json.media_url }}',\n      'timestamp', NOW()\n    )::jsonb\n  ],\n  batch_expires_at = NOW() + INTERVAL '3 seconds',\n  last_message_ts = EXTRACT(EPOCH FROM NOW())::bigint,\n  last_lead_message_ts = EXTRACT(EPOCH FROM NOW())::bigint,\n  updated_at = NOW()\nWHERE id = {{ $('Batch: Check Active').item.json.chat_id }}\nRETURNING\n  id,\n  contact_id,\n  array_length(batch_messages, 1) as total_messages;",
        "options": {}
      },
      "id": "1836ec19-d373-44e3-98e3-22baf6636dea",
      "name": "Batch: Add Message",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2400,
        -480
      ],
      "credentials": {
        "postgres": {
          "id": "HCvX4Ypw2MiRDsdm",
          "name": "Postgres Core"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id FROM corev4_contacts\nWHERE whatsapp = '={{ $('Execute: Normalize Evolution Data').item.json.whatsapp_id }}'\n  AND company_id = {{ $('Execute: Normalize Evolution Data').item.json.company_id || 1 }}\nLIMIT 1;",
        "options": {}
      },
      "id": "47356c7d-7eab-41e6-9494-af22c47cde23",
      "name": "Batch: Get Contact ID",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2848,
        -192
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "HCvX4Ypw2MiRDsdm",
          "name": "Postgres Core"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "contact-found",
              "leftValue": "={{ $('Batch: Get Contact ID').item.json.id != null }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "630024d2-37b8-487c-ac8b-208f1ceec8ef",
      "name": "Batch: Contact Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2624,
        -192
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO corev4_chats (\n  contact_id,\n  company_id,\n  batch_collecting,\n  batch_expires_at,\n  batch_messages,\n  last_message_ts,\n  last_lead_message_ts,\n  conversation_open\n) VALUES (\n  {{ $('Batch: Get Contact ID').item.json.id }},\n  {{ $('Execute: Normalize Evolution Data').item.json.company_id || 1 }},\n  TRUE,\n  NOW() + INTERVAL '3 seconds',\n  ARRAY[\n    jsonb_build_object(\n      'message_id', '={{ $('Execute: Normalize Evolution Data').item.json.message_id }}',\n      'whatsapp_id', '={{ $('Execute: Normalize Evolution Data').item.json.whatsapp_id }}',\n      'message_content', '={{ $('Execute: Normalize Evolution Data').item.json.message_content }}',\n      'message_type', '={{ $('Execute: Normalize Evolution Data').item.json.message_type }}',\n      'media_type', '={{ $('Execute: Normalize Evolution Data').item.json.media_type }}',\n      'has_media', {{ $('Execute: Normalize Evolution Data').item.json.has_media }},\n      'media_url', '={{ $('Execute: Normalize Evolution Data').item.json.media_url }}',\n      'timestamp', NOW()\n    )::jsonb\n  ],\n  EXTRACT(EPOCH FROM NOW())::bigint,\n  EXTRACT(EPOCH FROM NOW())::bigint,\n  TRUE\n)\nON CONFLICT (contact_id, company_id) DO UPDATE\nSET\n  batch_collecting = TRUE,\n  batch_expires_at = NOW() + INTERVAL '3 seconds',\n  batch_messages = ARRAY[\n    jsonb_build_object(\n      'message_id', '={{ $('Execute: Normalize Evolution Data').item.json.message_id }}',\n      'whatsapp_id', '={{ $('Execute: Normalize Evolution Data').item.json.whatsapp_id }}',\n      'message_content', '={{ $('Execute: Normalize Evolution Data').item.json.message_content }}',\n      'message_type', '={{ $('Execute: Normalize Evolution Data').item.json.message_type }}',\n      'media_type', '={{ $('Execute: Normalize Evolution Data').item.json.media_type }}',\n      'has_media', {{ $('Execute: Normalize Evolution Data').item.json.has_media }},\n      'media_url', '={{ $('Execute: Normalize Evolution Data').item.json.media_url }}',\n      'timestamp', NOW()\n    )::jsonb\n  ],\n  last_message_ts = EXTRACT(EPOCH FROM NOW())::bigint,\n  last_lead_message_ts = EXTRACT(EPOCH FROM NOW())::bigint,\n  conversation_open = TRUE,\n  updated_at = NOW()\nRETURNING id, contact_id;",
        "options": {}
      },
      "id": "6f3a82ba-7135-439c-b0a2-029aef0cb042",
      "name": "Batch: Create New",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2400,
        -288
      ],
      "credentials": {
        "postgres": {
          "id": "HCvX4Ypw2MiRDsdm",
          "name": "Postgres Core"
        }
      }
    },
    {
      "parameters": {},
      "id": "e51b119c-6763-487d-b73c-c8bcc5f09b1c",
      "name": "Batch: Merge Actions",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -2176,
        -384
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "should-wait",
              "leftValue": "{{ true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9be188a3-8ff3-4b5a-adbe-684282c074f2",
      "name": "Batch: Should Wait?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1952,
        -384
      ]
    },
    {
      "parameters": {
        "jsCode": "// Mensagem não pode fazer batch (novo contato)\n// Deixa passar direto para próximo node\nconst normalized = $('Execute: Normalize Evolution Data').first().json;\n\nreturn [{\n  json: {\n    ...normalized,\n    batch_mode: false,\n    batch_reason: 'new_contact'\n  }\n}];"
      },
      "id": "b9efeed9-40ee-4b52-a5ab-660fa8a6b481",
      "name": "Batch: Pass Non-Batchable",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2400,
        -96
      ]
    },
    {
      "parameters": {},
      "id": "8dafc849-1f60-4b15-92a7-3280bc517570",
      "name": "Batch: Output",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -2176,
        -96
      ],
      "notes": "Aguardando (vazio) ou Passa direto (novo contato)"
    }
  ],
  "pinData": {},
  "connections": {
    "Execute: Normalize Evolution Data": {
      "main": [
        [
          {
            "node": "Batch: Check Active",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route: Audio Messages": {
      "main": [
        [
          {
            "node": "Execute: Transcribe Audio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge: Audio and Text",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge: Audio and Text": {
      "main": [
        [
          {
            "node": "Filter: Valid Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter: Valid Messages": {
      "main": [
        [
          {
            "node": "Query: Message Deduplication",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query: Message Deduplication": {
      "main": [
        [
          {
            "node": "Route: Duplicate Detection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route: Duplicate Detection": {
      "main": [
        [
          {
            "node": "Respond: Webhook Acknowledgment",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Insert: Deduplication Record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond: Webhook Acknowledgment": {
      "main": [
        [
          {
            "node": "Prepare: Contact Lookup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare: Contact Lookup": {
      "main": [
        [
          {
            "node": "Fetch: Contact Record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch: Contact Record": {
      "main": [
        [
          {
            "node": "Enrich: Message Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enrich: Message Context": {
      "main": [
        [
          {
            "node": "Route: Contact Status",
            "type": "main",
            "index": 0
          },
          {
            "node": "Background: Update Interaction & Reschedule",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route: Contact Status": {
      "main": [
        [
          {
            "node": "Prepare: Create Contact",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare: Reactivate",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare: Process Command",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepare: Frank Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge: Workflow Results": {
      "main": [
        [
          {
            "node": "Prepare: Frank Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore: Frank Context": {
      "main": [
        [
          {
            "node": "Execute: CoreAdapt One Flow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute: Transcribe Audio": {
      "main": [
        [
          {
            "node": "Merge: Audio and Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert: Deduplication Record": {
      "main": [
        [
          {
            "node": "Respond: Webhook Acknowledgment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Receive: WhatsApp Webhook": {
      "main": [
        [
          {
            "node": "Execute: Normalize Evolution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare: Create Contact": {
      "main": [
        [
          {
            "node": "Execute: CoreAdapt Genesis Flow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare: Reactivate": {
      "main": [
        [
          {
            "node": "Execute: Reactivate Contact",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare: Process Command": {
      "main": [
        [
          {
            "node": "Execute: CoreAdapt Commands Flow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute: Reactivate Contact": {
      "main": [
        [
          {
            "node": "Merge: Workflow Results",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Prepare: Frank Chat": {
      "main": [
        [
          {
            "node": "Restore: Frank Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute: CoreAdapt Genesis Flow": {
      "main": [
        [
          {
            "node": "Merge: Workflow Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute: CoreAdapt Commands Flow": {
      "main": [
        [
          {
            "node": "Merge: Workflow Results",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Batch: Check Active": {
      "main": [
        [
          {
            "node": "Batch: Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch: Exists?": {
      "main": [
        [
          {
            "node": "Batch: Add Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Batch: Get Contact ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch: Add Message": {
      "main": [
        [
          {
            "node": "Batch: Merge Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch: Get Contact ID": {
      "main": [
        [
          {
            "node": "Batch: Contact Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch: Contact Exists?": {
      "main": [
        [
          {
            "node": "Batch: Create New",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Batch: Pass Non-Batchable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch: Create New": {
      "main": [
        [
          {
            "node": "Batch: Merge Actions",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Batch: Merge Actions": {
      "main": [
        [
          {
            "node": "Batch: Should Wait?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch: Pass Non-Batchable": {
      "main": [
        [
          {
            "node": "Batch: Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch: Output": {
      "main": [
        [
          {
            "node": "Route: Audio Messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "e3d1ae77-1fb3-4c30-9b1d-6708beb89c0a",
  "meta": {
    "instanceId": "5c6394fedb685d155bbe72063becfd91d616d8e123397941c9863e7b805328ae"
  },
  "id": "8Yip7wZKcGEYTgoo",
  "tags": [
    {
      "updatedAt": "2025-10-16T11:45:27.519Z",
      "createdAt": "2025-10-16T11:45:27.519Z",
      "id": "eTCC1MPmHZOu7LAH",
      "name": "corev4"
    }
  ]
}