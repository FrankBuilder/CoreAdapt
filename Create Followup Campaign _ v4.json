{
  "name": "Create Followup Campaign | v4",
  "nodes": [
    {
      "parameters": {
        "options": {}
      },
      "id": "8215355b-3a29-4104-b176-3b44adf5823b",
      "name": "Loop Over Steps",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        0,
        256
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "contact_id",
              "value": "={{ $json.contact_id }}",
              "type": "number"
            },
            {
              "id": "2",
              "name": "company_id",
              "value": "={{ $json.company_id }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "6f44aa8d-a275-45a8-a71e-ed4faec9f496",
      "name": "Prepare: Campaign Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1120,
        256
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "campaign_id",
              "value": "={{ $json.id }}",
              "type": "number"
            },
            {
              "id": "2",
              "name": "contact_id",
              "value": "={{ $('Prepare: Campaign Data').item.json.contact_id }}",
              "type": "number"
            },
            {
              "id": "3",
              "name": "company_id",
              "value": "={{ $('Prepare: Campaign Data').item.json.company_id }}",
              "type": "number"
            },
            {
              "id": "4",
              "name": "total_steps",
              "value": "={{ $('Fetch: Company Config').first().json.total_steps }}",
              "type": "number"
            },
            {
              "id": "5",
              "name": "timing_pattern",
              "value": "={{ $('Fetch: Company Config').first().json.timing_pattern }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id": "36622d5c-858f-4554-b895-08ff92f78fef",
      "name": "Extract: Campaign ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -448,
        256
      ]
    },
    {
      "parameters": {
        "jsCode": "// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n// NODE: Create: Followup Steps\n// VERSÃƒO: CORRIGIDA - OpÃ§Ã£o 1 (2025-10-29)\n// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nconst contact_id = $input.first().json.contact_id;\nconst company_id = $input.first().json.company_id;\nconst total_steps = $input.first().json.total_steps;\nconst timing_pattern = $input.first().json.timing_pattern;\n\n// Timing padrÃ£o em HORAS: 1h, 4h, 24h, 72h, 168h (1h, 4h, 1d, 3d, 7d)\n// Usado apenas se tabela corev4_followup_steps estiver vazia\n// CORRIGIDO 2025-11-10: Alinhado com Master Document\nconst defaultTiming = [1, 4, 24, 72, 168];\n\n// âœ… Base time: agora em UTC\nconst now = new Date();\nconst followups = [];\n\nfor (let step = 1; step <= total_steps; step++) {\n  // âœ… Pegar timing da tabela (agora em HORAS) ou usar padrÃ£o\n  const hours = timing_pattern?.[`step_${step}`] || defaultTiming[step - 1] || (step * 24);\n  \n  // âœ… Calcular timestamp futuro (JavaScript em UTC)\n  const scheduledTime = new Date(now.getTime() + hours * 60 * 60 * 1000);\n  \n  // âœ… Converter para ISO 8601 - PostgreSQL converte para timestamptz\n  const scheduled_at = scheduledTime.toISOString();\n  \n  followups.push({\n    json: {\n      contact_id: contact_id,\n      company_id: company_id,\n      step: step,\n      scheduled_at: scheduled_at,  // \"2025-10-30T14:30:00.000Z\"\n      \n      // ğŸ“Š Metadata para debug (opcional)\n      hours_from_now: hours,\n      timing_source: timing_pattern?.[`step_${step}`] ? 'database' : 'default'\n    }\n  });\n}\n\nreturn followups;"
      },
      "id": "0c15b9f6-1269-4fa8-a813-66557cbf60ec",
      "name": "Create: Followup Steps",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        256
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  c.id as config_id,\n  c.total_steps,\n  -- âœ… CORRIGIDO: Retorna em HORAS (nÃ£o minutos)\n  jsonb_object_agg(\n    'step_' || s.step_number,\n    (s.wait_hours + ROUND(s.wait_minutes::numeric / 60, 2))\n  ) FILTER (WHERE s.step_number IS NOT NULL) as timing_pattern\nFROM corev4_followup_configs c\nLEFT JOIN corev4_followup_steps s ON s.config_id = c.id\nWHERE c.company_id = $1\n  AND c.is_active = true\nGROUP BY c.id, c.total_steps\nORDER BY c.created_at DESC\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ [ $('Prepare: Campaign Data').item.json.company_id ] }}"
        }
      },
      "id": "d8e82202-97c8-498e-8429-c1d017c4c0fa",
      "name": "Fetch: Company Config",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -896,
        256
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "HCvX4Ypw2MiRDsdm",
          "name": "Postgres Core"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {},
      "id": "7a3c7c14-797b-4108-8e6e-644d8fb5ed1c",
      "name": "Receive: Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        -1344,
        256
      ]
    },
    {
      "parameters": {
        "tableId": "corev4_followup_campaigns",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "contact_id",
              "fieldValue": "={{ $('Prepare: Campaign Data').item.json.contact_id }}"
            },
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('Prepare: Campaign Data').item.json.company_id }}"
            },
            {
              "fieldId": "config_id",
              "fieldValue": "={{ $('Fetch: Company Config').first().json.config_id }}"
            },
            {
              "fieldId": "total_steps",
              "fieldValue": "={{ $('Fetch: Company Config').first().json.total_steps }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "active"
            },
            {
              "fieldId": "should_continue",
              "fieldValue": "true"
            }
          ]
        }
      },
      "id": "a9708ba0-2eca-4b3f-8a28-dd234a9139ab",
      "name": "Insert: Campaign Record",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -672,
        256
      ],
      "credentials": {
        "supabaseApi": {
          "id": "LCC4ysI1Fxd9iDGz",
          "name": "Supabase Core"
        }
      }
    },
    {
      "parameters": {
        "tableId": "corev4_followup_executions",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "campaign_id",
              "fieldValue": "={{ $('Extract: Campaign ID').item.json.campaign_id }}"
            },
            {
              "fieldId": "contact_id",
              "fieldValue": "={{ $('Loop Over Steps').item.json.contact_id }}"
            },
            {
              "fieldId": "company_id",
              "fieldValue": "={{ $('Loop Over Steps').item.json.company_id }}"
            },
            {
              "fieldId": "step",
              "fieldValue": "={{ $('Loop Over Steps').item.json.step }}"
            },
            {
              "fieldId": "total_steps",
              "fieldValue": "={{ $('Extract: Campaign ID').item.json.total_steps }}"
            },
            {
              "fieldId": "scheduled_at",
              "fieldValue": "={{ $('Loop Over Steps').item.json.scheduled_at }}"
            }
          ]
        }
      },
      "id": "deb27ab1-67a2-4bfe-8a3c-1079093bb8a0",
      "name": "Insert: Execution Record",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        224,
        160
      ],
      "credentials": {
        "supabaseApi": {
          "id": "LCC4ysI1Fxd9iDGz",
          "name": "Supabase Core"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "success",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "2",
              "name": "campaign_id",
              "value": "={{ $('Extract: Campaign ID').item.json.campaign_id }}",
              "type": "number"
            },
            {
              "id": "3",
              "name": "total_steps_created",
              "value": "={{ $('Extract: Campaign ID').item.json.total_steps }}",
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "id": "83c61f9e-53aa-4a34-8f03-5d1d6cec9bbe",
      "name": "Format: Output",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        224,
        352
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Loop Over Steps": {
      "main": [
        [
          {
            "node": "Format: Output",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Insert: Execution Record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare: Campaign Data": {
      "main": [
        [
          {
            "node": "Fetch: Company Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract: Campaign ID": {
      "main": [
        [
          {
            "node": "Create: Followup Steps",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create: Followup Steps": {
      "main": [
        [
          {
            "node": "Loop Over Steps",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch: Company Config": {
      "main": [
        [
          {
            "node": "Insert: Campaign Record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Receive: Workflow Trigger": {
      "main": [
        [
          {
            "node": "Prepare: Campaign Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert: Campaign Record": {
      "main": [
        [
          {
            "node": "Extract: Campaign ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert: Execution Record": {
      "main": [
        [
          {
            "node": "Loop Over Steps",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "7c346b86-1070-42aa-8324-85443145b1e6",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5c6394fedb685d155bbe72063becfd91d616d8e123397941c9863e7b805328ae"
  },
  "id": "8Sfia6n3SqQIqjpd",
  "tags": [
    {
      "updatedAt": "2025-10-16T11:45:27.519Z",
      "createdAt": "2025-10-16T11:45:27.519Z",
      "id": "eTCC1MPmHZOu7LAH",
      "name": "corev4"
    }
  ]
}